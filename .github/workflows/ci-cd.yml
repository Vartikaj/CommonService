name : Continuous integration and development

on : 
  push:
    branches:
      - master


jobs:
  build: 
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v3

      - name: Setup .dotnet8
        uses : actions/setup-dotnet@v3
        with :
          dotnet-version: '8.0.*'

      - name: Install PowerShell
        run: sudo apt-get update && sudo apt-get install -y powershell

      - name: Restore Dependencies
        run: dotnet restore

      - name : Remove old Build
        run : dotnet clean CommonService/CommonService.csproj

      - name: Build app
        run: dotnet build CommonService/CommonService.csproj --configuration Release --verbosity detailed

      - name: Publish DLL
        run : dotnet publish CommonService/CommonService.csproj --configuration Release --output ./publish

      - name: Verify DLL
        run: ls -l ./publish
      
      - name: Install Git (if needed)
        run: sudo apt-get update && sudo apt-get install -y git
      - name: Check Git Installation
        run: git --version
        # Function to Clone, Copy, Commit, and Push
      - name: Update DLL in Multiple Repositories
        run: |
          update_repo() {
            REPO=$1
            REPOPATH=$2
            CSPROJ_FILE="$REPO/$REPOPATH/$REPOPATH.csproj"  # Assuming the csproj file is named same as repo

            git clone https://github.com/Vartikaj/$REPO.git
            mkdir -p $REPO/$REPOPATH/libs
            cp ./publish/CommonService.dll $REPO/$REPOPATH/libs

            echo "Updating .csproj file..."
            pwsh -Command "
            \$csprojFile = '$CSPROJ_FILE';
            \$itemGroupContent = @'
            <ItemGroup>
                <Folder Include=\"libs\\\" />
            </ItemGroup>
            <ItemGroup>
                <Reference Include=\"CommonService\">
                    <HintPath>libs/CommonService.dll</HintPath>
                </Reference>
            </ItemGroup>
            '@;

            \$csprojContent = Get-Content \$csprojFile -Raw;
            if (\$csprojContent -notmatch '<Folder Include=\"libs\\\" />') {
                \$updatedContent = \$csprojContent -replace '(</Project>)', \"\$itemGroupContent`n`$1\";
                Set-Content -Path \$csprojFile -Value \$updatedContent;
                Write-Host 'Updated \$csprojFile successfully!';
            } else {
                Write-Host 'Folder entry already exists in \$csprojFile. No changes made.';
            }"

            echo "Committing changes..."
            cd $REPO
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add $REPOPATH/libs/CommonService.dll
            git commit -m "Updated CommonService.dll - $(date)"
            git push https://x-access-token:${{ secrets.GIT_PAT_SECERTS }}@github.com/Vartikaj/$REPO.git HEAD:master
            cd ..
          }

          update_repo "MasterService" "MasterServiceDemo"
          update_repo "UserService" "UserService"
        env:
          GH_PAT: ${{ secrets.GIT_PAT_SECERTS }}
          
          
