name : Continuous integration and development

on : 
  push:
    branches:
      - master


jobs:
  build: 
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v3

      - name: Setup .dotnet8
        uses : actions/setup-dotnet@v3
        with :
          dotnet-version: '8.0.*'

      - name: Restore Dependencies
        run: dotnet restore

      - name : Remove old Build
        run : dotnet clean CommonService/CommonService.csproj

      - name: Build app
        run: dotnet build CommonService/CommonService.csproj --configuration Release --verbosity detailed

      - name: Publish DLL
        run : dotnet publish CommonService/CommonService.csproj --configuration Release --output ./publish

      - name: Verify DLL
        run: ls -l ./publish
      
      - name: Clone the Master Service Repository
        run: |
          git clone https://github.com/Vartikaj/MasterService.git
          mkdir -p MasterServiceDemo/MasterServiceDemo/libs
          cp ./publish/CommonService.dll MasterServiceDemo/MasterServiceDemo/libs
        env:
          GIT_USER: ${{ secrets.GIT_USERNAME }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Commit and Push DLL to Master Service Repo
        run: |
          cd MasterServiceDemo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add MasterServiceDemo/libs/CommonService.dll
          git commit -m "Updated CommonService.dll - $(date)"
          git push https://x-access-token:${{ secrets.GIT_TOKEN }}@github.com/Vartikaj/MasterService.git
          
